# Спецификация семантического анализатора

## Обзор

Семантический анализатор проверяет корректность программы: типы, области видимости, разрешение имен, корректность вызовов функций.

**Входные данные:** `Program` - AST программы

**Выходные данные:** `AnalysisResult` - результат анализа с глобальной таблицей символов

**Обработка ошибок:** При обнаружении первой ошибки выбрасывается `SemanticException`, прерывая анализ.

## Таблица символов

### Структура Scope

```kotlin
class Scope {
    val variables: Map<String, VariableSymbol>
    val functions: Map<String, FunctionSymbol>
    val parent: Scope?
}
```

### Операции

- `defineVariable(symbol)` - добавить переменную (возвращает false при дублировании)
- `defineFunction(symbol)` - добавить функцию (возвращает false при дублировании)
- `resolveVariable(name)` - найти переменную по цепочке областей
- `resolveFunction(name)` - найти функцию по цепочке областей

## Типы данных

```kotlin
sealed class Type {
    object Int : Type()
    object Float : Type()
    object Bool : Type()
    object Void : Type()
    data class Array(val elementType: Type) : Type()
    object Unknown : Type()  // при ошибках
    object Primitive : Type()  // для встроенных функций
    object AnyArray : Type()  // для встроенных функций
}
```

## Проверки

### 1. Проверка типов

**Присваивание:** Тип правой части должен точно совпадать с типом левой части.

**Арифметика:** Оба операнда должны иметь одинаковый числовой тип (`int` или `float`).

**Остаток от деления:** Работает только с `int`.

**Сравнения:** Оба операнда должны иметь одинаковый числовой тип, результат - `bool`.

**Равенство:** Работают с одинаковыми типами, результат - `bool`.

**Логические операции:** Оба операнда должны быть `bool`.

**Унарные операции:**
- `-`, `+` - применимы к `int` и `float`
- `!` - применимо только к `bool`

### 2. Разрешение имен

- Все используемые переменные должны быть определены
- Все вызываемые функции должны быть определены
- Переменная не может использоваться как функция
- Функция не может использоваться как переменная

### 3. Управление областями видимости

- Shadowing разрешено во вложенных областях
- Дублирование в одной области запрещено
- Параметры функции доступны только внутри функции

### 4. Проверка функций

- Дублирование параметров запрещено
- Дублирование функций запрещено (нет перегрузки)
- Количество аргументов должно совпадать с количеством параметров
- Типы аргументов должны совпадать с типами параметров

### 5. Встроенные функции

- `print(value: primitive): void` - печать примитивных типов
- `printArray(value: array): void` - печать массивов

### 6. Проверка return

- `return` вне функции - ошибка
- `return` в void-функции должен быть без значения
- `return` в не-void функции должен быть со значением
- Тип возвращаемого значения должен совпадать с типом функции

### 7. Проверка массивов

- Индекс должен быть типа `int`
- Индексация не-массивов - ошибка
- Тип присваиваемого значения должен совпадать с типом элементов массива

### 8. Проверка условий

- Условие в `if` должно быть `bool`
- Условие в `for` должно быть `bool` (если указано)

## Интерфейс

```kotlin
interface SemanticAnalyzer {
    fun analyze(program: Program): AnalysisResult
}

data class AnalysisResult(
    val program: Program,
    val globalScope: Scope,
    val error: SemanticError?
)
```
