name: Link PR to Issue by NOCOUNTRY key

on:
  pull_request:
    types: [opened, edited, reopened, synchronize, closed]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  prefix-title:
    runs-on: ubuntu-latest
    if: github.event.action == 'opened' || github.event.action == 'edited' || github.event.action == 'reopened' || github.event.action == 'synchronize'
    steps:
      - name: Prefix PR title with branch name
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;

            // Skip forks (token will not have write permissions)
            if (pr.head.repo.full_name !== pr.base.repo.full_name) {
              console.log("‚ö†Ô∏è PR is from a fork ‚Äî skipping title prefixing");
              return;
            }

            const { owner, repo } = context.repo;
            const branchName = pr.head.ref;
            const prefix = `${branchName}: `;

            if ((pr.title || "").startsWith(prefix)) {
              console.log("‚ÑπÔ∏è Title already prefixed with branch name");
              return;
            }

            const updatedTitle = `${prefix}${pr.title}`;
            await github.rest.pulls.update({
              owner,
              repo,
              pull_number: pr.number,
              title: updatedTitle
            });
            console.log(`‚úÖ Prefixed PR title with branch name: "${updatedTitle}"`);

  link:
    runs-on: ubuntu-latest
    needs: prefix-title
    if: github.event.action == 'opened' || github.event.action == 'edited' || github.event.action == 'reopened' || github.event.action == 'synchronize'
    steps:
      - name: Link PR to issue
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;

            // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º PR –∏–∑ fork ‚Äî –Ω–µ—Ç –ø—Ä–∞–≤ –ø–∏—Å–∞—Ç—å
            if (pr.head.repo.full_name !== pr.base.repo.full_name) {
              console.log("‚ö†Ô∏è PR is from a fork ‚Äî skipping linking");
              return;
            }

            // –ò—â–µ–º –ø—Ä–µ—Ñ–∏–∫—Å –≤–∏–¥–∞ NOCOUNTRY-123 (–¥–æ–ø—É—Å–∫–∞–µ–º —Ä–∞–∑–Ω—ã–µ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏ –∏ —Ç–∏—Ä–µ)
            const match = pr.title.match(/\bNOCOUNTRY[-_‚Äì‚Äî ]?(\d+)\b/i);
            if (!match) {
              console.log("‚ùå No NOCOUNTRY-<number> found in PR title");
              return;
            }

            const issueNumber = match[1];
            const issueKey = `NOCOUNTRY-${issueNumber}`;

            // –ò—â–µ–º issue –ø–æ –ø—Ä–µ—Ñ–∏–∫—Å—É –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ —á–µ—Ä–µ–∑ Search API (—É—á–∏—Ç—ã–≤–∞–µ—Ç –∏ –æ—Ç–∫—Ä—ã—Ç—ã–µ, –∏ –∑–∞–∫—Ä—ã—Ç—ã–µ)
            const q = `repo:${context.repo.owner}/${context.repo.repo} is:issue in:title "${issueKey}"`;
            const search = await github.rest.search.issuesAndPullRequests({ q, per_page: 50 });
            const linkedIssue = search.data.items.find(i => i.title.startsWith(issueKey));
            if (!linkedIssue) {
              console.log(`‚ö†Ô∏è Issue with prefix ${issueKey} not found via search`);
              return;
            }

            // –ü—Ä–æ–≤–µ—Ä–∏–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–≥–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è, —á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ synchronize
            const existingComments = await github.paginate(
              github.rest.issues.listComments,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: linkedIssue.number,
                per_page: 100
              }
            );
            const hasComment = existingComments.some(c => (c.body || "").includes(`#${pr.number}`));
            if (!hasComment) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: linkedIssue.number,
                body: `üîó **–°–≤—è–∑–∞–Ω–Ω—ã–π PR:** [#${pr.number} - ${pr.title}](${pr.html_url})`
              });
            } else {
              console.log(`‚ÑπÔ∏è Comment already exists for PR #${pr.number} on issue #${linkedIssue.number}`);
            }

            // –û–±–Ω–æ–≤–∏–º –æ–ø–∏—Å–∞–Ω–∏–µ PR: –∑–∞–º–µ–Ω–∏–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å—Ç—Ä–æ–∫—É, —á—Ç–æ–±—ã –Ω–µ –ø–ª–æ–¥–∏—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã
            const markerRegex = /\*\*–°–≤—è–∑–∞–Ω–Ω–∞—è issue:\*\*\s*#\d+/i;
            const currentBody = pr.body || "";
            const desiredLine = `**–°–≤—è–∑–∞–Ω–Ω–∞—è issue:** #${linkedIssue.number}`;
            let updatedBody;
            if (markerRegex.test(currentBody)) {
              updatedBody = currentBody.replace(markerRegex, desiredLine);
            } else {
              updatedBody = `${currentBody}\n\n${desiredLine}`.trim();
            }

            if (updatedBody !== currentBody) {
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                body: updatedBody
              });
            } else {
              console.log("‚ÑπÔ∏è PR body already contains the correct linked issue line");
            }

            console.log(`‚úÖ Linked PR #${pr.number} ‚Üí Issue #${linkedIssue.number} (${issueKey})`);

  close-issue:
    runs-on: ubuntu-latest
    if: github.event.action == 'closed'
    steps:
      - name: Close linked issue on PR close/merge
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;

            // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º PR –∏–∑ fork ‚Äî —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–æ–∫ –ø—Ä–∞–≤
            if (pr.head.repo.full_name !== pr.base.repo.full_name) {
              console.log("‚ö†Ô∏è PR is from a fork ‚Äî skipping issue close");
              return;
            }

            const { owner, repo } = context.repo;

            // –ù–∞—Ö–æ–¥–∏–º –∫–ª—é—á NOCOUNTRY-<n> –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ PR
            const match = pr.title.match(/\bNOCOUNTRY[-_‚Äì‚Äî ]?(\d+)\b/i);
            if (!match) {
              console.log("‚ùå No NOCOUNTRY-<number> found in PR title");
              return;
            }

            const issueNumber = match[1];
            const issueKey = `NOCOUNTRY-${issueNumber}`;

            // –ò—â–µ–º issue –ø–æ –ø—Ä–µ—Ñ–∏–∫—Å—É –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏
            const q = `repo:${owner}/${repo} is:issue in:title "${issueKey}"`;
            const search = await github.rest.search.issuesAndPullRequests({ q, per_page: 50 });
            const linkedIssue = search.data.items.find(i => i.title.startsWith(issueKey));
            if (!linkedIssue) {
              console.log(`‚ö†Ô∏è Issue with prefix ${issueKey} not found via search`);
              return;
            }

            if (linkedIssue.state === 'closed') {
              console.log(`‚ÑπÔ∏è Issue #${linkedIssue.number} already closed`);
              return;
            }

            // –ó–∞–∫—Ä—ã–≤–∞–µ–º issue
            await github.rest.issues.update({
              owner,
              repo,
              issue_number: linkedIssue.number,
              state: 'closed'
            });

            // –î–æ–±–∞–≤–∏–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å –ø—Ä–∏—á–∏–Ω–æ–π
            const reason = pr.merged ? '–º–µ—Ä–¥–∂–µ–º PR' : '–∑–∞–∫—Ä—ã—Ç–∏–µ–º PR –±–µ–∑ –º–µ—Ä–¥–∂–∞';
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: linkedIssue.number,
              body: `‚úÖ –ó–∞–∫—Ä—ã—Ç–æ ${reason}: PR #${pr.number} (${pr.title})`
            });

            console.log(`‚úÖ Closed issue #${linkedIssue.number} due to PR #${pr.number} closed`);
